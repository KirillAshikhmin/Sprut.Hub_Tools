
# Циркадное освещение
# Глобальный и логический сценарии

Глобальный и логический сценарий для реализации полноценного циркадного освещения для ламп в Sprut.Hub.

## Логический сценарий

Режим активируется для каждой конкретной лампы и всегда работает когда она включена, обновляя значения яркости и цветовой температуры, если лампа поддерживает или оттенка с насыщенностью раз в 5 минут.

# Установка и обновление
## Инструкция по установке

 1. Скачать архив с сценариями по [этой ссылке](https://github.com/KirillAshikhmin/Sprut.Hub_Tools/raw/refs/heads/main/CircadianLight/CircadianLight.zip)
 2. Открыть в интерфейсе Sprut.Hub вкладку сценарии,
 3. Нажать справа сверху кнопку +, выбрать "Импортировать шаблон" и по очереди импортировать все файлы, закрывая открывшийся экран с кодом сценария.
 4. Зайти в нужное устройство (тип - Лампочка)
 5. Если прошивка 1.10 и выше, то в настройки (шестерёнка сверху справа), для версий младше сразу на следующий шаг
 6. Логика
 7. Циркадное освещение
 8. Активировать

Теперь для данной лампы будет активен режим циркадного освещения и он включается вместе с включением лампы и отключается с её выключением. При этом яркость и температура меняются плавно каждые 5 минут в соответствии с выбранным режимом. Параметры режимов указаны в глобальном сценарии "Циркадное освещение. Глобальный. Параметры".

## Инструкция по обновлению
Для обновления есть 2 способа:
1. Удалить логический и глобальный сценарии и импортировать по новой, при этом могут сброситься настроенные параметры сценария и его активация у устройств.
2. Зайти [в папку source](https://github.com/KirillAshikhmin/Sprut.Hub_Tools/tree/main/CircadianLight/source), открыть файл сценария (Глобальный, логический и тд) и заменить содержимое соответствующего сценария в хабе на код из репозтория.
Для удобства обновления в версии 2.2 параметры режимов вынесены в отдельный глобальный сценарий, для того, что бы при изменении не было необходимости сохранять или по новой вводить свои настройки освещения. Сценарий Параметры может измениться только при крайней необходимости, если будет такая - напишу об ътом в списке изменений. По умолчанию с версиями обновляется 2 сенария - Глобальный и Логический.

## Параметры
#### Не менять параметр автоматически после его ручного изменения.
Если включено, то при ручном (или внешнем) изменении любого параметра (яркость, температура, оттенок, насыщенность) это сохранение запомнится и не будет устанавливаться циркадное значение. Сбрасывается при выключении лампы.

#### Останавливать циркадный режим после изменения любого параметра.
Если включено, то при изменении любого параметра лампочки циркадный режим отключается до следующего включения лампы. Если включить лампу изменением яркости, то циркадный режим запущен не будет, только установится температура. Для работы этого параметра необходимо включить пункт "Не менять яркость автоматически после ручного изменения."

#### Режим работы - Несколько пресетов с разными параметрами яркости и температуры. 
-  0 - Долго держится большая яркость, температура света утром холодает медленее
-  1 - Яркость вечером уменьшается раньше, утром включается холодный свет
-  2 - С постоянной максимальной яркостью. утром включается холодный свет
  
Настройки режимов можно изменить в глобальном сценарии. А так же можно добавить свои режимы.

#### Что изменять? 
Определяет режим работы сценария.
0 - Изменять яркость и цветовую температуру
1 - только яркость
2 - только цветовую температуру

#### Плавное изменение яркости при включении
Экспериментальная функция! Может быть не стабильно! Плохо работает с лампамя со связями.
Позволяет плавно увеличивать яркость лампы при включении.

## Описание сценариев
### Глобальный сценарий
Используется для получения и установки циркадного освещения для ламп. Логический не работает без глобального!
Примеры:
Установить для одной лампочки: global.setCircadianLight(99);
Установить для нескольких лампочек global.setCircadianLight([97,98,99]);
Так же в метод setCircadianLight можно передать 2 параметра:
preset (Integer) - режим работы
dontChangeBright (Boolean) - не менять яркость при её ручном изменении

Получить значение температуры и яркости для текущего часа и минуты:
let tempAndBright = global.getCircadianLight(preset);
preset (Integer) - режим работы
Результат будет в виде массива
tempAndBright[0] - температура
tempAndBright[1] - яркость.
Используется, если необходимо получить только одно значение, например при использовании лампочки в качестве будильника получать температуру, а яркость увеличивать постепенно.

### Конвертер температуры в цвет
Дополнительный логический сценарий для конвертирования температуры в цвет у виртуальных устройств. 
Используется в связях (Одна лампа управляет группой ламп): Создаётся виртуальная лампа только с яркостью и температурой. Она связывается с лампами, которые тоже умеют управлять температурой, а так же с виртуальной лампой, где включена эта логика конвертера. А её уже с реальными лампами, которые умеют менять оттенок и насыщенность, но не умеют менять температуру. Это необходимо из-за того, что если есть температура, то управление идёт по температуре, если температуры нет, но есть оттенок и насыщенность, то ими. Потому что это взаимозаменяющие вещи, и, если управлять тем и тем, то результат будет не предсказуем. 

## Взаимодействие с режимом из сценариев
#### Перезапуск циркадного режима
Если включён режим "Не менять параметр автоматически" или "Останавливать циркадный режим после любого изменения", то при изменении любого параметра он перестаёт изменяться автоматически, при изменении всех параметров циркадный режим отключается для выбранного устройства. Существует 2 способа перезапустить циркадный режим для лампы:
1. Выключить и включить лампочку
2. Из Блока кода в нужный момент вызвать функцию
```
global.resetCircadianLight(Hub.getAccessory(aId).getService(sId))
```
где:
aId - Идентификатор аксессуара
sId - Идентификатор сервиса.
При этом лампа остаётся включённой, применится яркость и температура согласно режиму работы и будет обновляться.

#### Временное отключение циркадного режима
Если на лампе активирована логика "Циркадный режим", тогда она всегда работает в этом режиме.
Для временного отключения можно или деактивировать логику из интерфейса или выключить его из Блока кода:
```
global.setCircadianLightDisabled(Hub.getAccessory(aId).getService(sId), disabled)
```
где:
aId - Идентификатор аксессуара
sId - Идентификатор сервиса
disabled - Фраг отключения. true - циркадный режим отключён, false - выключен. При перезагрузке хаба значение сбрасывается.
Если включить чиркадный режим, на включённой лампе, то для его активации необходимо выключить и включить лампу. Перезапуск не сработает.



# Ссылки
### Следить за обновлениями
Вы можете отслеживать новости о Циркадном режиме и других моих сценариях в моём [Telergam-канале Умный Спутник](https://t.me/smart_sputnik)
### Поддержить автора можно 
Если хотите поддержать автора - Переходите и подписывайтесь в [Boosty](https://boosty.to/smart_kirill). Есть подписка или цель для однократного доната. 



# История изменений:
## 4.0
- Отказ от метода compute для определения способа включения лампы
- Улучшение интерфейса настроек логики
- Исправлена проблема с некорректным рассчётом температуры в промежутке с 23 до 00 часов, из-за чего ровно в полночь можно было заметить резкое изменение параметров. 
- Добавлены новые удобные методы для временного отключения циркадного режима
- Улучшено логирование - теперь отладку можно включить в настройках логики для конкретного устройства.

## 3.1
- Исправление работы с лампами без поддержки цветовой температуры (появившийся в версии 3.0)
- Теперь можно останавливать и запускать циркадный режим из сценария не перезапуская лампу

## 3.0
- Плавное включение (Экспериментально, не стабильно, если включается на связанных светильниках)
- Возможность перезапускать циркадный режим не выключая лампу через сценарии
- Возможность включать отключать циркадный режим для лампы через сценарии
- Возможно настроить что бы менялась только яркость или только температура
- Исправление ошибки "ReferenceError: "source" is not defined"
- Оптимизирован запуск что бы минимизировать время включения со старыми параметрами
- Улучшено логирование (опять)

## 2.2
- Параметры (режимы, температура в яркость и насыщенность) вынесены в отдельный сценарий, что бы можно было проще обновлять основной с логикой, а параметры не трогать.
- Добавлена толлератность для изменения характееристик - больше 1. Иногда приходило от девайса значение отличающее на 1 от того, что мы хотели и от этого не менялась температура.
- Доработано логирование

## 2.1
- Добавлен дополнительный логический сценарий "Конвертер температуры в цвет"
- Почистил сценарий от лшнего лога и ненужного кода

## 2.0 
- Эмуляция цветовой температуры посредством изменения оттенка и насыщенности, если у лампы нет этого параметра
- Опция "Останавливать циркадный режим после изменения любого параметра."
- Опция "Не менять яркость автоматически после ручного изменения" заменена на "Не менять параметр автоматически"
- Доработано логирование
- Добавлена глобальная функция global.getHueAndSaturationFromMired(temp) - которая возвращает массив [оттенок, насыщенность] для указанной температуры в майредах (как в хабе 50-400)
- Немного изменён формат задания режимов для удобства


## 1.0 Первый релиз




# Все сценарии бесплатные и можно свободно использовать как в личных, так и в коммерческих целях.
