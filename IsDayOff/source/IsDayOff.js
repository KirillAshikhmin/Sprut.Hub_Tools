// –í—ã–Ω–æ—Å–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ info
const scenarioName = {
  ru: "üìÖ IsDayOff - –í—ã—Ö–æ–¥–Ω–æ–π –ª–∏ –¥–µ–Ω—å?",
  en: "üìÖ IsDayOff - Is Day Off?"
};

const scenarioDescription = {
  ru: "–õ–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π (–∏–ª–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π) –¥–µ–Ω—å –≤—ã—Ö–æ–¥–Ω—ã–º (–Ω–µ—Ä–∞–±–æ—á–∏–º) –∏—Å–ø–æ–ª—å–∑—É—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–µ—Ä–≤–∏—Å isdayoff.ru.\n\n–í—ã–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∫–ª—é—á—ë–Ω –µ—Å–ª–∏ –¥–µ–Ω—å –≤—ã—Ö–æ–¥–Ω–æ–π, –∏–Ω–∞—á–µ, –µ—Å–ª–∏ –¥–µ–Ω—å —Ä–∞–±–æ—á–∏–π - –≤—ã–∫–ª—é—á–µ–Ω.",
  en: "Logical scenario that checks if the current day is a day off (non-working day) using the isdayoff.ru internet service.\n\nThe switch is turned on if the day is a day off, otherwise, if the day is a working day - turned off."
};

info = {
  name: scenarioName.ru,
  description: scenarioDescription.ru,
  version: "1.2",
  author: "@BOOMikru and isdayoff.ru",
  onStart: true,
  sourceServices: [HS.Switch],
  sourceCharacteristics: [HC.On],
  options: {
    daysOffset: {
      name: {
        en: "Days offset",
        ru: "–í—ã—Ö–æ–¥–Ω–æ–π –ª–∏ —á–µ—Ä–µ–∑"
      },
      desc: {
        en: "Checks if the day is a day off after the specified number of days. 0 - Today, 1 - Tomorrow, 2 - Day after tomorrow, -1 - Yesterday, etc.",
        ru: "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤—ã—Ö–æ–¥–Ω—ã–º –¥–µ–Ω—å —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—É—Ç–æ–∫. 0 - –°–µ–≥–æ–¥–Ω—è, 1 - –ó–∞–≤—Ç—Ä–∞, 2 - –ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞, -1 - –í—á–µ—Ä–∞ –∏ —Ç.–¥."
      },
      type: "Integer",
      value: 0,
      minValue: -365,
      maxValue: 365,
      step: 1
    },
    changeServiceName: {
      name: {
        en: "Change service name",
        ru: "–ú–µ–Ω—è—Ç—å –∏–º—è —Å–µ—Ä–≤–∏—Å–∞"
      },
      desc: {
        en: "If enabled, the service name will change to show the day status (e.g., 'Today is a day off', 'Tomorrow is a working day')",
        ru: "–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –¥–Ω—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–°–µ–≥–æ–¥–Ω—è –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å', '–ó–∞–≤—Ç—Ä–∞ —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å')"
      },
      type: "Boolean",
      value: false
    },
    countryCode: {
      name: {
        en: "Country code",
        ru: "–ö–æ–¥ —Å—Ç—Ä–∞–Ω—ã"
      },
      desc: {
        en: "Country code for the determination of days off. Available: Belarus (by), Kazakhstan (kz), Russia (ru), Ukraine (ua), USA (us), Uzbekistan (uz), Turkey (tr), Latvia (lv)",
        ru: "–ö–æ–¥ —Å—Ç—Ä–∞–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–Ω–µ–π. –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã: –ë–µ–ª–∞—Ä—É—Å—å (by), –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω (kz), –†–æ—Å—Å–∏—è (ru), –£–∫—Ä–∞–∏–Ω–∞ (ua), –°–®–ê (us), –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω (uz), –¢—É—Ä—Ü–∏—è (tr), –õ–∞—Ç–≤–∏—è (lv)"
      },
      type: "String",
      value: "ru"
    },
    sixDayWorkWeek: {
      name: {
        en: "Six-day work week",
        ru: "–®–µ—Å—Ç–∏–¥–Ω–µ–≤–Ω–∞—è —Ä–∞–±–æ—á–∞—è –Ω–µ–¥–µ–ª—è"
      },
      desc: {
        en: "If enabled, considers a six-day work week (Saturday is a working day)",
        ru: "–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, —Å—á–∏—Ç–∞–µ—Ç —á—Ç–æ –Ω–µ–¥–µ–ª—è —à–µ—Å—Ç–∏–¥–Ω–µ–≤–Ω–∞—è (—Å—É–±–±–æ—Ç–∞ —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å)"
      },
      type: "Boolean",
      value: false
    },
    html: {
      name: {
        ru: ""
      },
      desc: {
        ru: ""
      },
      type: "String",
      value: "–°—Ü–µ–Ω–∞—Ä–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ—Ä–≤–∏—Å <a href='https://www.isdayoff.ru/' target='_blank'>isDayOff.ru</a> - API –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç—ã –Ω–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫ –Ω–µ—Ä–∞–±–æ—á–µ–º—É –¥–Ω—é —Å–æ–≥–ª–∞—Å–Ω–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º —É–∫–∞–∑–∞–º –∏ —Ä–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏—è–º.",
      formType: "html"
    }
  },
  variables: {
    midnightTask: undefined  // Cron –∑–∞–¥–∞—á–∞ –¥–ª—è –µ–∂–µ—Å—É—Ç–æ—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  }
}

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ IsDayOff
const IS_DAY_OFF_CONSTANTS = {
  DEBUG: true,
  API_URL: "https://isdayoff.ru/api/getdata?year=",
  API_UPDATE_TIME_MS: 1000 * 3600 * 24 * 10,  // —Ä–∞–∑ –≤ 10 –¥–Ω–µ–π –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
  API_ERR_UPDATE_TIME_MS: 1000 * 3600 * 3,  // —Ä–∞–∑ –≤ 3 —á–∞—Å–∞ –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –±—ã–ª–∞ –æ—à–∏–±–∫–∞
  ERROR_VALUE: false,  // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Å—á–∏—Ç–∞–µ–º –¥–µ–Ω—å —Ä–∞–±–æ—á–∏–º
  MS_PER_SECOND: 1000,
  SECONDS_PER_MINUTE: 60,
  MINUTES_PER_HOUR: 60,
  HOURS_PER_DAY: 24,
  NON_WORKING_DAY_CHAR: '1',  // —Å–∏–º–≤–æ–ª –≤ –æ—Ç–≤–µ—Ç–µ API, –æ–∑–Ω–∞—á–∞—é—â–∏–π –Ω–µ—Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
  API_RESPONSE_PATTERN: /^[0124]{365,366}$/  // –ø–∞—Ç—Ç–µ—Ä–Ω –≤–∞–ª–∏–¥–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ API
};

// –î–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
// –§–æ—Ä–º–∞—Ç –∫–ª—é—á–∞: '–≥–æ–¥_–∫–æ–¥_—Å—Ç—Ä–∞–Ω—ã_—Ç–∏–ø_–Ω–µ–¥–µ–ª–∏' –≥–¥–µ —Ç–∏–ø_–Ω–µ–¥–µ–ª–∏: 0 = –ø—è—Ç–∏–¥–Ω–µ–≤–Ω–∞—è, 1 = —à–µ—Å—Ç–∏–¥–Ω–µ–≤–Ω–∞—è
const DEFAULT_DATA = {
  '2025_ru_0': '11111111001100000110000011000001100000110000011000001100000110000011000001100000110000011000001100000110000011000001100011110001111000001100000110000011000001100011110000011000001100000110000011000001100000110000011000001100000110000011000001100000110000011000001100000110000011000001100000110000011000000111000110000011000001100000110000011000001100000110000011001',
  '2025_ru_1': '11111111000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100010010001101000000100000010000001000000100010010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000101000010000001000000100000010000001000000100000010000001001',
  '2025_by_0': '11011110000100000110000011000001100000110000011000001100000110000011000001100000110000011000001100000110000011000000111010110000111000001100000110000011000001100000110000011000001100011110000001000001100000110000011000001100000110000011000001100000110000011000001100000110000011000001100000110000011000001100001110000011000001100000110000011000001100000010001111000',
  '2025_by_1': '00001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000',
  '2025_kz_0': '11110010001100000110000011000001100000110000011000001100000110000011100001100001111100011000001100000110000011000001100010110010111000001100000110000011000011100000110000011000001100000111000011000001100000110000011000001100000110000011000001110000110000011000001100000110000011000001100000110000011100001100000110000011000001100000110000011000001101000110000011000',
  '2025_kz_1': '00000000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000',
  '2025_ua_0': '10011010001100000110000011000001100000110000011000001100000110000011000001100000110000011000001100000110000011000001100011110000111000001100000110000011000001100000110000011000001100000110000011000001100000110000011000001100000110000011000001100000110000011000001100000110000011000001101000110000011000001100000110000011000001100000110000011000001100000110000011000',
  '2025_uz_0': '10011000001100000110000011000001100000110000011000001100000110000011000001100001110000011100001100000110000011000001100000110000111000001100000110000011000001100000110000011000001100000110000011000001100000110000011000001100000110000011000001110000110000011000001100000110010011000001100000110000011000001100000110000011000001100000110000011100001100000110000011000',
  '2025_uz_1': '00001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000',
  '2026_ru_0': '11111111111000001100000110000011000001100000110000011100001100000111000011000001100000110000011000001100000110000011000011100000111000011000001100000110000011000011100000110000011000001100000110000011000001100000110000011000001100000110000011000001100000110000011000001100000110000011000001100000110000011001001100000110000011000001100000110000011000001100000110001',
  '2026_ru_1': '00010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000001000000100000010000'
};

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
const CONTEXT_CONSTANTS = {
  DELIMITER: ' <- ',
  LOGIC_PREFIX: 'LOGIC',
  CHARACTERISTIC_PREFIX: 'C',
  MIN_ELEMENTS: 3
};

// ============================================================================
// –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø - –¢–û–ß–ö–ê –í–•–û–î–ê
// ============================================================================
function trigger(source, value, variables, options, context) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–¥–µ–ª–∞–Ω–æ –Ω–µ —Å–∞–º–∏–º —Å—Ü–µ–Ω–∞—Ä–∏–µ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–æ–≤
  if (isSelfChanged(context)) {
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Å—Ç–æ—á–Ω–∏–∫ - —ç—Ç–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ On
  if (source.getType() !== HC.On) {
    return;
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞
  updateDayOffStatus(source, variables, options);

  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Cron –∑–∞–¥–∞—á—É –¥–ª—è –µ–∂–µ—Å—É—Ç–æ—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –ø–æ–ª–Ω–æ—á—å
  setupMidnightUpdateTask(source, variables, options);
}

// ============================================================================
// –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–¢–ê–¢–£–°–ê
// ============================================================================

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è –∏ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞
 * @param {Object} source - –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–±—ã—Ç–∏—è (—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞)
 * @param {Object} variables - –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
 * @param {Object} options - –æ–ø—Ü–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è
 */
function updateDayOffStatus(source, variables, options) {
    // –ü–æ–ª—É—á–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–Ω–µ–π –∏–∑ –æ–ø—Ü–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0 - —Å–µ–≥–æ–¥–Ω—è)
    const daysOffset = options.daysOffset !== undefined ? options.daysOffset : 0;
  
    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏)
    const isDayOff = IsDayOff(daysOffset, options);
  
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É On
    source.setValue(isDayOff);
  
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è —Å–µ—Ä–≤–∏—Å–∞, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è
    updateServiceName(source, variables, options, daysOffset, isDayOff);
  }

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–µ–Ω—å –≤—ã—Ö–æ–¥–Ω—ã–º (–Ω–µ—Ä–∞–±–æ—á–∏–º) —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π
 * @param {number} daysOffset - —Å–º–µ—â–µ–Ω–∏–µ –≤ –¥–Ω—è—Ö (0 - —Å–µ–≥–æ–¥–Ω—è, 1 - –∑–∞–≤—Ç—Ä–∞, -1 - –≤—á–µ—Ä–∞ –∏ —Ç.–¥.)
 * @param {Object} options - –æ–ø—Ü–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è
 * @returns {boolean} true - –¥–µ–Ω—å –≤—ã—Ö–æ–¥–Ω–æ–π, false - —Ä–∞–±–æ—á–∏–π
 */
function IsDayOff(daysOffset, options) {
  // –ï—Å–ª–∏ daysOffset –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º 0 (—Å–µ–≥–æ–¥–Ω—è)
  if (daysOffset === undefined) {
    daysOffset = 0;
  }

  // –ï—Å–ª–∏ options –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç
  if (options === undefined) {
    options = {};
  }

  // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–ª–µ–≤—É—é –¥–∞—Ç—É —Å —É—á–µ—Ç–æ–º —Å–º–µ—â–µ–Ω–∏—è
  const targetDate = getDateWithOffset(daysOffset);
  const year = targetDate.getFullYear();
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª—é—á –¥–∞–Ω–Ω—ã—Ö —Å —É—á–µ—Ç–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å—Ç—Ä–∞–Ω—ã –∏ —Ä–∞–±–æ—á–µ–π –Ω–µ–¥–µ–ª–∏
  const countryCode = options.countryCode || 'ru';
  const sixDayWorkWeek = options.sixDayWorkWeek === true ? '1' : '0';
  const dataKey = 'isdayoff_' + year + '_' + countryCode + '_' + sixDayWorkWeek;
  
  const currentTime = Date.now();

  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–æ–¥–∞ —Ü–µ–ª–µ–≤–æ–π –¥–∞—Ç—ã
  const holidayData = getHolidayDataForYear(year, dataKey, currentTime, options);
  
  if (!holidayData) {
    return IS_DAY_OFF_CONSTANTS.ERROR_VALUE;
  }

  // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–º–µ—Ä –¥–Ω—è –≤ –≥–æ–¥—É –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –¥–∞—Ç—ã (–æ—Ç 1 –¥–æ 365/366)
  const dayOfYear = getDayOfYear(targetDate, year);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–º–≤–æ–ª –≤ —Å—Ç—Ä–æ–∫–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ü–µ–ª–µ–≤–æ–≥–æ –¥–Ω—è
  // '1' –æ–∑–Ω–∞—á–∞–µ—Ç –Ω–µ—Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
  const isDayOff = holidayData.charAt(dayOfYear - 1) === IS_DAY_OFF_CONSTANTS.NON_WORKING_DAY_CHAR;

  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω DEBUG
  if (IS_DAY_OFF_CONSTANTS.DEBUG) {
    const dateStr = formatDaysOffsetString(daysOffset);
    console.log(`–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è: ${dateStr} ${isDayOff ? '–≤—ã—Ö–æ–¥–Ω–æ–π' : '—Ä–∞–±–æ—á–∏–π'}`);
  }

  return isDayOff;
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–Ω—è—Ö –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≥–æ–¥–∞
 * @param {number} year - –≥–æ–¥
 * @param {string} dataKey - –∫–ª—é—á –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ GlobalVariables
 * @param {number} currentTime - —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
 * @param {Object} options - –æ–ø—Ü–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è
 * @returns {string|null} —Å—Ç—Ä–æ–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ null –ø—Ä–∏ –æ—à–∏–±–∫–µ
 */
function getHolidayDataForYear(year, dataKey, currentTime, options) {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
  if (!GlobalVariables.isdayoff_next_refresh) {
    GlobalVariables.isdayoff_next_refresh = currentTime + IS_DAY_OFF_CONSTANTS.API_UPDATE_TIME_MS;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ
  const shouldUpdate = !GlobalVariables[dataKey] || (GlobalVariables.isdayoff_next_refresh < currentTime);

  if (shouldUpdate) {
    fetchAndUpdateHolidayData(year, dataKey, currentTime, options);
  }

  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  if (IS_DAY_OFF_CONSTANTS.DEBUG) {
    logDebugInfo(dataKey, GlobalVariables.isdayoff_next_refresh, currentTime);
  }

  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ null –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
  return GlobalVariables[dataKey] || null;
}

/**
 * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–Ω—è—Ö —É API
 * @param {number} year - –≥–æ–¥
 * @param {string} dataKey - –∫–ª—é—á –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
 * @param {number} currentTime - —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
 * @param {Object} options - –æ–ø—Ü–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è
 */
function fetchAndUpdateHolidayData(year, dataKey, currentTime, options) {
  let apiResponse = '';

  try {
    // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    const countryCode = options.countryCode || 'ru';
    const sixDayWorkWeek = options.sixDayWorkWeek === true ? 1 : 0;
    
    // API_URL —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç "?year=", –ø–æ—ç—Ç–æ–º—É –¥–æ–±–∞–≤–ª—è–µ–º –≥–æ–¥ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–µ–∑ &
    let apiUrl = IS_DAY_OFF_CONSTANTS.API_URL + year;
    apiUrl += '&cc=' + countryCode;
    if (sixDayWorkWeek === 1) {
      apiUrl += '&sd=1';
    }

    apiResponse = HttpClient.GET(apiUrl).send().getBody();
  } catch (error) {
    log.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–∞ isdayoff –¥–ª—è –≥–æ–¥–∞ {}: {}", year, error);
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (—Å—Ç—Ä–æ–∫–∞ –∏–∑ —Å–∏–º–≤–æ–ª–æ–≤ 0,1,2,4 –¥–ª–∏–Ω–æ–π 365 –∏–ª–∏ 366 —Å–∏–º–≤–æ–ª–æ–≤)
  if (IS_DAY_OFF_CONSTANTS.API_RESPONSE_PATTERN.test(apiResponse)) {
    GlobalVariables[dataKey] = apiResponse;
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
    GlobalVariables.isdayoff_next_refresh = currentTime + IS_DAY_OFF_CONSTANTS.API_UPDATE_TIME_MS;
  } else {
    log.error("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –æ—Ç–≤–µ—Ç–µ —Å–µ—Ä–≤–∏—Å–∞ isdayoff –¥–ª—è –≥–æ–¥–∞ {}: {}", 
      year, apiResponse.substring(0, 30));
    GlobalVariables.isdayoff_next_refresh = currentTime + IS_DAY_OFF_CONSTANTS.API_ERR_UPDATE_TIME_MS;

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç –∏ –æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ–¥–∞, —Å—Ç—Ä–∞–Ω—ã –∏ —Ç–∏–ø–∞ –Ω–µ–¥–µ–ª–∏
    const defaultDataKey = year.toString() + '_' + countryCode + '_' + sixDayWorkWeek;
    if (!GlobalVariables[dataKey] && DEFAULT_DATA[defaultDataKey]) {
      GlobalVariables[dataKey] = DEFAULT_DATA[defaultDataKey];
      console.log("–ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è isdayoff: –≥–æ–¥ {}, —Å—Ç—Ä–∞–Ω–∞ {}, –Ω–µ–¥–µ–ª—è {}", year, countryCode, sixDayWorkWeek === 1 ? '—à–µ—Å—Ç–∏–¥–Ω–µ–≤–Ω–∞—è' : '–ø—è—Ç–∏–¥–Ω–µ–≤–Ω–∞—è');
    }
  }
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –Ω–æ–º–µ—Ä –¥–Ω—è –≤ –≥–æ–¥—É (–æ—Ç 1 –¥–æ 365/366) —Å —É—á–µ—Ç–æ–º –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
 * @param {Date} date - –¥–∞—Ç–∞
 * @param {number} year - –≥–æ–¥
 * @returns {number} –Ω–æ–º–µ—Ä –¥–Ω—è –≤ –≥–æ–¥—É (1-366)
 */
function getDayOfYear(date, year) {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏
  // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É 1 —è–Ω–≤–∞—Ä—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≥–æ–¥–∞ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  const startOfYear = new Date(year, 0, 1);
  // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –¥–∞—Ç—ã –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (—Ç–æ–ª—å–∫–æ –¥–∞—Ç–∞, –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏)
  const targetDate = new Date(year, date.getMonth(), date.getDate());
  
  // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
  const msPerDay = IS_DAY_OFF_CONSTANTS.MS_PER_SECOND * 
    IS_DAY_OFF_CONSTANTS.SECONDS_PER_MINUTE * 
    IS_DAY_OFF_CONSTANTS.MINUTES_PER_HOUR * 
    IS_DAY_OFF_CONSTANTS.HOURS_PER_DAY;
  
  const diffMs = targetDate - startOfYear;
  const dayOfYear = Math.floor(diffMs / msPerDay) + 1;
  
  return dayOfYear;
}

/**
 * –õ–æ–≥–∏—Ä—É–µ—Ç –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
 * @param {string} dataKey - –∫–ª—é—á –¥–∞–Ω–Ω—ã—Ö
 * @param {number} nextRefreshTime - –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
 * @param {number} currentTime - —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
 */
function logDebugInfo(dataKey, nextRefreshTime, currentTime) {
  const dataLength = GlobalVariables[dataKey] ? GlobalVariables[dataKey].length : 0;
  const msPerHour = IS_DAY_OFF_CONSTANTS.MS_PER_SECOND * 
    IS_DAY_OFF_CONSTANTS.SECONDS_PER_MINUTE * 
    IS_DAY_OFF_CONSTANTS.MINUTES_PER_HOUR;
  const hoursToUpdate = (nextRefreshTime - currentTime) / msPerHour;
  
  console.log("–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: {}, —Å–ª–µ–¥. –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —á–∞—Å–æ–≤: {}", dataLength, hoursToUpdate);
}

// ============================================================================
// CRON –ó–ê–î–ê–ß–ò
// ============================================================================

/**
 * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç Cron –∑–∞–¥–∞—á—É –¥–ª—è –µ–∂–µ—Å—É—Ç–æ—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤ –ø–æ–ª–Ω–æ—á—å
 * @param {Object} source - –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–±—ã—Ç–∏—è (—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞)
 * @param {Object} variables - –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
 * @param {Object} options - –æ–ø—Ü–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è
 */
function setupMidnightUpdateTask(source, variables, options) {
  // –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—ë –µ—â–µ –Ω–µ—Ç
  if (!variables.midnightTask) {
    variables.midnightTask = Cron.schedule("0 0 0 * * *", function () {
      try {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞
        updateDayOffStatus(source, variables, options);
      } catch (error) {
        log.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É–Ω–æ—á–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: {}", error);
      }
    });
  }
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –¥–Ω—è
 * @param {Object} source - –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–±—ã—Ç–∏—è (—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞)
 * @param {Object} variables - –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
 * @param {Object} options - –æ–ø—Ü–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è
 * @param {number} daysOffset - —Å–º–µ—â–µ–Ω–∏–µ –≤ –¥–Ω—è—Ö
 * @param {boolean} isDayOff - —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–µ–Ω—å –≤—ã—Ö–æ–¥–Ω—ã–º
 */
function updateServiceName(source, variables, options, daysOffset, isDayOff) {
  // –ï—Å–ª–∏ –æ–ø—Ü–∏—è –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
  if (!options.changeServiceName) {
    return;
  }

  try {
    const service = source.getService();
    if (!service) {
      return;
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ –∏–º—è
    const dateStr = formatDaysOffsetString(daysOffset);
    const statusStr = isDayOff ? "–≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å" : "—Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å";
    const newName = `${dateStr} ${statusStr}`;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ –∏–º—è
    service.setName(newName);
  } catch (error) {
    log.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–º–µ–Ω–∏ —Å–µ—Ä–≤–∏—Å–∞: {}", error);
  }
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞—Ç—É —Å —É—á–µ—Ç–æ–º —Å–º–µ—â–µ–Ω–∏—è –≤ –¥–Ω—è—Ö
 * @param {number} daysOffset - —Å–º–µ—â–µ–Ω–∏–µ –≤ –¥–Ω—è—Ö (0 - —Å–µ–≥–æ–¥–Ω—è, 1 - –∑–∞–≤—Ç—Ä–∞, -1 - –≤—á–µ—Ä–∞)
 * @returns {Date} –¥–∞—Ç–∞ —Å —É—á–µ—Ç–æ–º —Å–º–µ—â–µ–Ω–∏—è
 */
function getDateWithOffset(daysOffset) {
  const currentDate = new Date();
  const targetDate = new Date(currentDate);
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –≤ –¥–Ω—è—Ö
  targetDate.setDate(currentDate.getDate() + daysOffset);
  
  return targetDate;
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å–º–µ—â–µ–Ω–∏—è –¥–Ω–µ–π
 * @param {number} daysOffset - —Å–º–µ—â–µ–Ω–∏–µ –≤ –¥–Ω—è—Ö
 * @returns {string} –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
 */
function formatDaysOffsetString(daysOffset) {
  switch (daysOffset) {
    case 0:
      return "–°–µ–≥–æ–¥–Ω—è";
    case 1:
      return "–ó–∞–≤—Ç—Ä–∞";
    case 2:
      return "–ü–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞";
    case -1:
      return "–í—á–µ—Ä–∞";
    case -2:
      return "–ü–æ–∑–∞–≤—á–µ—Ä–∞";
    default:
      if (daysOffset > 2) {
        return `–ß–µ—Ä–µ–∑ ${daysOffset} ${getDaysWord(daysOffset)}`;
      } else {
        const absOffset = Math.abs(daysOffset);
        return `${absOffset} ${getDaysWord(absOffset)} –Ω–∞–∑–∞–¥`;
      }
  }
}

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ–æ—Ä–º—É —Å–ª–æ–≤–∞ "–¥–µ–Ω—å/–¥–Ω—è/–¥–Ω–µ–π"
 * @param {number} count - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π
 * @returns {string} —Ñ–æ—Ä–º–∞ —Å–ª–æ–≤–∞
 */
function getDaysWord(count) {
  const lastDigit = count % 10;
  const lastTwoDigits = count % 100;
  
  // –î–ª—è —á–∏—Å–µ–ª 11-19 –≤—Å–µ–≥–¥–∞ "–¥–Ω–µ–π"
  if (lastTwoDigits >= 11 && lastTwoDigits <= 19) {
    return "–¥–Ω–µ–π";
  }
  
  // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —á–∏—Å–µ–ª –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ü–∏—Ñ—Ä—É —á–µ—Ä–µ–∑ switch
  switch (lastDigit) {
    case 1:
      return "–¥–µ–Ω—å";
    case 2:
    case 3:
    case 4:
      return "–¥–Ω—è";
    default:
      return "–¥–Ω–µ–π";
  }
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ª–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ —Å–∞–º–∏–º —Å—Ü–µ–Ω–∞—Ä–∏–µ–º
 * –§–æ—Ä–º–∞—Ç context: "LOGIC_ID <- C_TYPE <- LOGIC_ID"
 * @param {Object} context - –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
 * @returns {boolean} true –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ —Å—Ü–µ–Ω–∞—Ä–∏–µ–º
 */
function isSelfChanged(context) {
  if (!context) return false;
  
  const elements = context.toString().split(CONTEXT_CONSTANTS.DELIMITER);
  return elements.length >= CONTEXT_CONSTANTS.MIN_ELEMENTS &&
    elements[0].startsWith(CONTEXT_CONSTANTS.LOGIC_PREFIX) &&
    elements[1].startsWith(CONTEXT_CONSTANTS.CHARACTERISTIC_PREFIX) &&
    elements[2] === elements[0];
}

