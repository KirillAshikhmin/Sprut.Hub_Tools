# Мастер-выключатель
# Глобальный сценарий и Логический сценарий (описание ниже)

## Выключает все лампы, выключатели, розетки, а так же другие устройства в доме или выбранной комнате. Функцию выключателя можно вызывать из любого сценария через блок кода. Можно вызывать функцию несколько раз с задержкой для разных устройств. Так же в дополнение есть логический сценарий, что бы установить его у устройства триггера и настроить все параметры через интерфейс.

### Основные поддерживаемые типы устройств для отключения (сценарий их находит сам):
- **Лампы** (HS.Lightbulb)
- **Выключатели** (HS.Switch)
- **Розетки** (HS.Outlet)

### Дополнительные поддерживаемые сервисы (через параметр `additionalDevices`):
- **Вентилятор** - HC.On = false
- **Очиститель воздуха** - HC.TargetAirPurifierState = 0
- **Нагреватель-охладитель** - HC.TargetHeaterCoolerState = 0
- **Увлажнитель-осушитель** - HC.TargetHumidifierDehumidifierState = 0
- **Термостат** - HC.TargetHeatingCoolingState = 0
- **Дверь** - HC.TargetPosition = 0
- **Гаражные ворота** - HC.TargetDoorState = 0
- **Водопроводный кран, Система полива, Кран, Штора, Окно** - HC.TargetPosition = 0
- **Динамик, Микрофон, ТВ динамик** - HC.Mute = true

### Все параметры функции `masterSwitch`:

| Параметр | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| `lightbulbs` | Boolean | `true` | Отключать лампочки |
| `switches` | Boolean | `true` | Отключать выключатели |
| `outlets` | Boolean | `false` | Отключать розетки |
| `hidden` | Boolean | `false` | Отключать скрытые устройства |
| `rooms` | Array | `[]` | Комнаты для выключения (пустой = весь дом) |
| `excludeRooms` | Array | `[]` | Комнаты для исключения |
| `excludeAccessories` | Array | `[]` | ID устройств/сервисов для исключения |
| `additionalDevices` | Array | `[]` | Дополнительные устройства для отключения |
| `interval` | Number | `0` | Интервал выключения в миллисекундах |
| `turnOffOrder` | Array | `[]` | Порядок выключения устройств |
| `verifyTurnOff` | Boolean | `true` | Повторять выключение через 5 секунд |
| `delayedDevices` | Array | `[]` | ID устройств и сервисов для отложенного выключения |
| `delayedTurnOffTime` | Number | `0` | Время отложенного выключения в миллисекундах |
| `debug` | Boolean | `false` | Режим отладки | 

### Поддерживаемые форматы исключений устройств:

#### Исключение целых аксессуаров:
- Целые числа: `130`, `188`
- Строки: `"130"`, `"188"`
- Массивы: `[130, 188]`, `["130", "188"]`

#### Исключение конкретных сервисов:
- Дробные числа: `130.13` (аксессуар 130, сервис 13)
- Строки с точкой: `"130.13"` (аксессуар 130, сервис 13)
- Массивы: `[130.13, 188.5]`, `["130.13", "188.5"]`

#### Смешанные форматы:
- `[130, "188", 200.15, "300.20"]` - поддерживает все форматы в одном массиве

### Использование:

#### Основная функция (рекомендуется):
```javascript
global.masterSwitch({
  // Типы устройств для отключения
  lightbulbs: true,
  switches: true,
  outlets: false,
  hidden: false,
  
  // Выбор комнат и исключения
  rooms: ["Кухня"],
  excludeRooms: ["Коридор", "Двор"],
  excludeAccessories: [130, 188.15],
  additionalDevices: [200, 300.5],
  
  // Настройки выключения
  interval: 500,
  turnOffOrder: [42, 123.15],
  verifyTurnOff: true,
  delayedDevices: [42, 123.15],
  delayedTurnOffTime: 5000,
  debug: false
})
```

**Внимание:** По умолчанию розетки не отключаются (`outlets = false`), так как это может привести к неожиданному отключению важных устройств (холодильник, серверы и т.д.).

#### Примеры использования:

1. **Простое выключение:**
   ```javascript
   global.masterSwitch({})
   ```

2. **Выбор конкретной комнаты:**
   ```javascript
   global.masterSwitch({
     rooms: ["Кухня"]
   })
   ```

3. **Исключение комнат:**
   ```javascript
   global.masterSwitch({
     excludeRooms: ["Коридор", "Двор"]
   })
   ```

4. **Исключение устройств:**
   ```javascript
   global.masterSwitch({
     excludeAccessories: [11, 42, 130.13, 188.5]
   })
   ```

5. **Дополнительные устройства:**
   ```javascript
   global.masterSwitch({
     additionalDevices: [200, 300.5]
   })
   ```

6. **Последовательное выключение:**
   ```javascript
   global.masterSwitch({
     interval: 1000,
     turnOffOrder: [130, 188.15]
   })
   ```

7. **Отложенное выключение:**
   ```javascript
   global.masterSwitch({
     delayedDevices: [42, 123.15], // ID устройств для отложенного выключения
     delayedTurnOffTime: 10000     // 10 секунд задержки
   })
   ```

8. **Полная настройка:** (все параметры опциональные, внутри функции можно задать параметры по умолчанию)
   ```javascript
   global.masterSwitch({
     rooms: ["Гостиная"],
     excludeRooms: ["Коридор"],
     excludeAccessories: [130, 188.15],
     additionalDevices: [200, 300.5],
     lightbulbs: true,
     switches: true,
     outlets: false,
     hidden: false,
     interval: 500,
     verifyTurnOff: true,
     delayedDevices: [42, 123.15],
     delayedTurnOffTime: 5000,
     debug: true
   })
   ```

9. **Обратная совместимость:**
   ```javascript
   global.turnOffLight(["Коридор"], [130, 188.15])
   ```

### Дополнительные устройства для отключения:

Параметр `additionalDevices` позволяет отключать любые типы устройств по их идентификаторам:

```javascript
var additionalDevices = [130, 188.15, "200.13"]; // Отключить устройства 130, сервис 15 устройства 188, сервис 13 устройства 200
```

#### Поддерживаются устройства с такими характеристиками:
- **HC.On** - для обычных устройств (лампы, выключатели, розетки)
- **HC.Active** - для устройств с активным состоянием
- **HC.TargetHeatingCoolingState** - для термостатов
- **HC.TargetHeaterCoolerState** - для нагревателей/охладителей
- **HC.TargetAirPurifierState** - для очистителей воздуха
- **HC.TargetHumidifierDehumidifierState** - для увлажнителей/осушителей
- **HC.TargetDoorState** - для дверей
- **HC.TargetPosition** - для штор, кранов и т.д.
- **HC.Mute** - для динамиков и микрофонов

#### Форматы идентификаторов:
- Целые числа: `130` (весь аксессуар)
- Дробные числа: `130.15` (аксессуар 130, сервис 15)
- Строки: `"130"`, `"130.15"`
- Массивы: `[130, 188.15, "200.13"]`

### Порядок выключения устройств:

Параметр `turnOffOrder` позволяет задать приоритетный порядок выключения устройств при последовательном выключении:

```javascript
var turnOffOrder = []; // Пустой массив - порядок не задан (по умолчанию)
var turnOffOrder = [130, 188.15, "200.13"]; // Приоритетный порядок выключения
```

#### Как работает порядок выключения:
1. **Работает только при последовательном выключении** (`interval > 0`)
2. **Сначала выключаются устройства** из списка `turnOffOrder` в указанном порядке
3. **Затем выключаются все остальные** устройства в произвольном порядке
4. **Проверяется существование** устройств в списке для выключения (опечатки игнорируются)

#### Поддерживаемые форматы ID:
- **Целые числа**: `130` (весь аксессуар)
- **Дробные числа**: `130.15` (аксессуар 130, сервис 15)
- **Строки**: `"130"`, `"130.15"`
- **Массивы**: `[130, 188.15, "200.13"]`

#### Примеры использования:
```javascript
// Выключить сначала лампу в спальне, затем выключатель в коридоре
global.masterSwitch({
  interval: 1000,
  turnOffOrder: [130, 188.15]
})

// Выключить сначала конкретные сервисы, затем все остальное
global.masterSwitch({
  interval: 500,
  turnOffOrder: ["200.13", 300.5, 150]
})
```

### Отложенное выключение устройств:

Параметры `delayedDevices` и `delayedTurnOffTime` позволяют настроить отложенное выключение определенных устройств:

```javascript
var delayedDevices = [42, 123.15, "200.13"]; // ID устройств для отложенного выключения
var delayedTurnOffTime = 5000; // Время задержки в миллисекундах (5 секунд)
```

#### Как работает отложенное выключение:
1. Устройства из списка `delayedDevices` **исключаются** из основного выключения
2. После завершения основного выключения запускается таймер на `delayedTurnOffTime` миллисекунд
3. Через указанное время устройства из `delayedDevices` выключаются
4. После отложенного выключения запускается проверка `verifyTurnOff` (если включена)

#### Примеры использования:
```javascript
// Выключить свет в коридоре через 10 секунд после основного выключения
global.masterSwitch({
  delayedDevices: [42, 123.15], // ID ламп в коридоре
  delayedTurnOffTime: 10000     // 10 секунд
})

// Выключить все устройства сразу, кроме лампы в спальне (через 30 секунд)
global.masterSwitch({
  delayedDevices: [200],        // ID лампы в спальне
  delayedTurnOffTime: 30000     // 30 секунд
})
```

### Повторное выключение устройств:

Параметр `verifyTurnOff` позволяет настроить повторное выключение устройств через 5 секунд:

```javascript
var verifyTurnOff = true; // Повторять выключение через 5 секунд (по умолчанию)
var verifyTurnOff = false; // Не повторять выключение
```

#### Как работает повторное выключение:
1. После завершения основного процесса выключения (одновременного или последовательного)
2. После завершения отложенного выключения (если настроено)
3. Через 5 секунд система проверяет все устройства, которые должны были выключиться
4. Если найдены устройства, которые все еще включены, процедура выключения повторяется
5. Повторное выключение происходит с теми же параметрами (интервал, тип устройств и т.д.)


### Последовательное выключение устройств:

Параметр `interval` позволяет настроить интервал выключения устройств:

```javascript
var interval = 0; // Одновременное выключение (по умолчанию)
var interval = 500; // Выключение с интервалом 500мс между устройствами
var interval = 1000; // Выключение с интервалом 1 секунда между устройствами
```

#### Валидация данных:
- Только положительные числа (0 и больше)
- Максимальное значение: 60000мс (1 минута)
- Шаг изменения: 100мс

#### Примеры использования:
- **0мс** - все устройства выключаются одновременно (быстро)
- **500мс** - устройства выключаются по очереди с интервалом полсекунды (эффект "волны")
- **2000мс** - медленное последовательное выключение (эффект "затухания")

### Отладка:
Установите `debug = true` для включения подробного логирования процесса исключений и последовательного выключения.

### Обратная совместимость:
- `global.turnOffLight(excludeRooms, excludeAccessories)` - функция для обратной совместимости со старой версией сценария. Но рекомендуется перейти на новую - global.masterSwitch()

### Параметры функции `turnOffLight` (обратная совместимость):

| Параметр | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| `excludeRooms` | Array | `[]` | Массив названий комнат для исключения |
| `excludeAccessories` | Array | `[]` | Массив ID аксессуаров/сервисов для исключения |

### Unit тесты:
В сценарии встроены unit тесты для проверки корректности работы всех функций. Для запуска тестов:
1. Установите сценарий Unit тестов (`UnitTests.js`)
2. В файле `MasterSwitch.js` установите `isDeveloping = true`
3. Сохраните сценарий - тесты запустятся автоматически

Тесты покрывают:
- Парсинг параметров и исключений
- Выключение различных типов устройств
- Работу с комнатами и исключениями
- Последовательное выключение
- Валидацию параметров
- Обратную совместимость
- Отладку и логирование


# Логический сценарий

## Реализует функцию Мастер выключатель в виде логического сценария для его упращенного включения и настройки без написания кода. Работает исключительно в паре с глобальным сценарием и вызывает его.

### Триггеры срабатывания:
- **Включение выключателя** (HS.Switch, HC.On = true)
- **Одиночное, Двойное и Долгое нажатие кнопки** (HS.StatelessProgrammableSwitch, HC.ProgrammableSwitchEvent) - настраивается режим
- **Счётчик импульсов** (HS.C_PulseMeter, HC.C_PulseCount > 0)
- **Датчик касания** (HS.ContactSensor, HC.ContactSensorState = 1)


### Установка и настройка:

1. **Установка сценария:**
   - Зайдите в раздел Сценарии
   - Нажмите кнопку +
   - Нажмите Импортировать шаблон 
   - Выберите файл MasterSwitch.json глобального сценария
   - Вернитесь обратно в список и, согласно шагам выше, импортируйте файл MasterSwitch.Logic.json логического сценария
   - Выберите устройство на которое будет подключаться сценарий (Кнопка, выключатель, датчик касания, счётчик)
   - Откройте экран управления устройством
   - Нажмите шестерёнку
   - Выберите пункт Логика
   - Нажмите на "Мастер выключатель"
   - Активируйте логику переключателем "Активно"
   - Настройте мастер-выключатель:

2. **Настройка опций:**

### **Настройка опций:**

#### **Триггеры (если сценарий подключен к кнопке):**
- **Одиночное нажатие** - по умолчанию: Отключено
- **Двойное нажатие** - по умолчанию: Отключено  
- **Долгое нажатие** - по умолчанию: Отключено

*Примечание: Можно включить несколько типов нажатий одновременно*

#### **Типы устройств для отключения:**
- **Отключать лампочки** - по умолчанию: Включено
- **Отключать выключатели** - по умолчанию: Включено
- **Отключать розетки** - по умолчанию: Отключено
- **Отключать скрытые устройства** - по умолчанию: Отключено

#### **Выбор области действия:**
- **Комната** - выбор комнаты для выключения устройств
  - "🏠 Весь дом" - выключает устройства во всех комнатах (по умолчанию)
  - Конкретная комната - выключает устройства только в выбранной комнате

#### **Исключения:**
- **Комнаты исключения** - названия комнат через запятую, где не надо выключать устройства
  - *Формат:* `"Коридор, Двор, Информер"`

- **Устройства исключения** - ID устройств и сервисов через запятую для исключения
  - *Формат:* `"130, 188.15, 200.13"` (ID аксессуара или ID аксессуара.ID сервиса)

#### **Дополнительные устройства:**
- **Выключить так же** - ID устройств и сервисов для отключения почти любых типов устройств, которые это поддерживают
  - *Формат:* `"200, 300.5, 400.12"` (ID аксессуара или ID аксессуара.ID сервиса)

#### **Настройки выключения:**
- **Выключать по очереди** - интервал выключения устройств в миллисекундах
  - *Формат:* число от 0 до 60000
  - *По умолчанию:* 0 (одновременно)
  - *Примеры:* 500 (полсекунды), 1000 (1 секунда), 2000 (2 секунды)

- **Порядок выключения** - ID устройств в порядке выключения, для отключения по очереди, только если интервал больше 0.
  - *Формат:* `"42, 123.15, 200.13"` приоритетные устройства первыми (ID аксессуара или ID аксессуара.ID сервиса)

- **Повторять выключение** - повторять выключение через 5 секунд? если остались включённые устройства - по умолчанию: Включено

#### **Отложенное выключение:**
- **Не отключать сразу** - ID устройств и сервисов через запятую, которые не выключаются сразу, а через указанное время
  - *Формат:* `"42, 123.15, 200.13"` (ID аксессуара или ID аксессуара.ID сервиса)

- **Отключить через (мс)** - время в миллисекундах, через которое выключить устройства из поля выше
  - *Формат:* число от 0 до 300000 (0 = не использовать отложенное выключение)
  - *По умолчанию:* 0
  - *Примеры:* 5000 (5 секунд), 10000 (10 секунд), 30000 (30 секунд)

- **Отладка** - дополнительное логирование для диагностики

### Дополнительно:
- Розетки по умолчанию не отключаются для предотвращения случайного отключения важных устройств
- Все настройки применяются индивидуально для каждого устройства-триггера и можно использовать несколько Мастер-выключателей
- Если возникли какие-то проблемы, то можно включить подробное логирование через опцию "Отладка"