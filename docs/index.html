<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Умный спутник - Редактор шаблонов Sprut.Hub</title>
    <meta name="description" content="Веб-редактор для создания и редактирования шаблонов сценариев Sprut.Hub с подсветкой синтаксиса и автодополнением">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/fold/foldgutter.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/dialog/dialog.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/dialog/dialog.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/history/history.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/addon/hint/json-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/6.12.6/ajv.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-untar@2.0.0/build/dist/untar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</head>
<body class="system">
    <div id="toastContainer" class="toast-container"></div>
    <div id="dropZone"><p>Перетащите JSON-файл сюда</p></div>
    <div id="templateDialog">
        <p>Файл содержит несколько шаблонов. Выберите один:</p>
        <select id="templateSelect"></select>
        <button onclick="confirmTemplateSelection()">Выбрать</button>
    </div>

    <!-- Editor Section -->
    <section class="editor-section">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="card scenario-card">
                        <div class="card-header lighting">
                            <h5 class="mb-0 card-header-flex">
                                <span class="flex-grow-1">
                                    <i class="fas fa-code"></i> Редактор шаблонов Sprut.Hub
                                    <small class="d-block mt-1" style="font-size: 0.8em; opacity: 0.9;">
                                        Создавайте, редактируйте, валидируйте и автоматически исправляйте шаблоны устройств
                                    </small>
                                </span>
                                <div class="theme-toggle">
                                    <button id="themeToggle" class="theme-toggle-btn" title="Переключить тему">
                                        <i class="fas fa-sun light-icon"></i>
                                        <i class="fas fa-moon dark-icon"></i>
                                    </button>
                                </div>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="button-row-top">
                                <div class="left-buttons">
                                    <input type="file" id="uploadFile" accept=".json" style="display: none;">
                                    <input type="file" id="autoFixFileInput" accept=".json,.zip,application/gzip,application/x-gzip,application/x-tar,.gz,.tar.gz" style="display: none;">
                                    <div style="display: flex; gap: 10px;">
                                        <button onclick="createEmptyTemplate()" class="btn btn-primary">
                                            <i class="fas fa-plus"></i> Создать
                                        </button>
                                        <button onclick="document.getElementById('uploadFile').click()" class="btn btn-outline-primary">
                                            <i class="fas fa-folder-open"></i> Открыть
                                        </button>
                                    </div>
                                </div>
                                <div class="right-buttons">
                                    <button onclick="downloadTemplate()" class="btn btn-success">
                                        <i class="fas fa-download"></i> Скачать
                                    </button>
                                </div>
                            </div>
                            <div class="editor-container">
                                <textarea id="jsonEditor"></textarea>
                            </div>
                            <div id="cursorPathMap" class="cursor-path"></div>
                            <div class="button-row-bottom">
                                <div class="left-buttons">
                                    <div class="schema-buttons-row">
                                        <button onclick="correctJson()" class="btn btn-warning">
                                            <i class="fas fa-wrench"></i> Исправить под требования Sprut.hub
                                        </button>
                                        <button onclick="validateJson()" class="btn btn-info">
                                            <i class="fas fa-check-circle"></i> Валидировать
                                        </button>
                                        <button onclick="formatJson()" class="btn btn-secondary">
                                            <i class="fas fa-indent"></i> Форматировать
                                        </button>
                                    </div>
                                    <div id="autoFixContainer"></div>
                                </div>
                                <div class="right-buttons">
                                    <div class="checkbox-container">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="oneClickOpenFileCheckbox">
                                            <span class="checkbox-text">Открывать файл</span>
                                        </label>
                                    </div>
                                    <button onclick="oneClickFix()" class="btn btn-danger">
                                        <i class="fas fa-magic"></i> Фикс в 1 клик
                                    </button>
                                </div>
                            </div>
                            <div id="correctionOutput"></div>
                            <div id="errorOutput"></div>
                            
                            <!-- Instructions Section -->
                            <div class="instructions-section">
                                <div class="instructions-header">
                                    <i class="fas fa-info-circle"></i>
                                    <h6 class="mb-0">Инструкция по использованию</h6>
                                </div>
                                <div class="instructions-content">
                                    <div class="instruction-variant">
                                        <h6>Вариант 1 (быстрый):</h6>
                                        <ol>
                                            <li>Откройте файл шаблона</li>
                                            <li>Нажмите "Фикс в 1 клик"</li>
                                            <li>Обновить шаблон в Sprut.hub</li>
                                        </ol>
                                    </div>
                                    <div class="instruction-variant">
                                        <h6>Вариант 2 (ручной):</h6>
                                        <ol>
                                            <li>Откройте файл шаблона</li>
                                            <li>Если в одном файле содержится несколько шаблонов, то в появившемся окне выберите необходимый</li>
                                            <li>Нажмите кнопку "Исправить под требования Sprut.hub" для автоматического исправления шаблона</li>
                                            <li>Нажмите кнопку "Валидировать" для проверки шаблона согласно JSON Schema</li>
                                            <li>Если в шаблоне есть ошибки валидации - нажмите "Попробовать исправить автоматически" и/или исправьте вручную</li>
                                            <li>Нажмите кнопку "Форматировать" для форматирования кода</li>
                                            <li>Скачайте шаблон</li>
                                            <li>Обновить шаблон в Sprut.hub</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Следить за обновлениями</h5>
                    <p>Отслеживайте новости о сценариях в Telegram-канале <a href="https://t.me/smart_sputnik" class="custom-link-blue">Умный Спутник</a></p>
                </div>
                <div class="col-md-6 text-md-end">
                    <h5>Поддержать автора</h5>
                    <p>Поддержите развитие проекта на <a href="https://boosty.to/smart_kirill" class="custom-link-blue">Boosty</a></p>
                    <div class="social-links">
                        <a href="https://t.me/smart_sputnik"><i class="fab fa-telegram"></i></a>
                        <a href="https://github.com/KirillAshikhmin/Sprut.Hub_Tools"><i class="fab fa-github"></i></a>
                    </div>
                </div>
            </div>
            <hr class="my-4">
            <div class="row">
                <div class="col-12 text-center">
                    <p>&copy; 2025 Умный спутник.<br>Sprut.hub — зарегистрированный товарный знак. Все права на бренд Sprut.hub принадлежат его правообладателю: ИП Пономарев Дмитрий Алексеевич.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Контекстное меню редактора -->
    <div id="contextMenu" class="context-menu" style="display:none;">
        <div class="context-menu-section">
            <div class="context-menu-item" data-action="selectAll">
                <i class="fas fa-object-group"></i>
                <span>Выделить всё</span>
                <span class="context-menu-shortcut">Ctrl+A</span>
            </div>
            <div class="context-menu-item" data-action="copy">
                <i class="fas fa-copy"></i>
                <span>Копировать</span>
                <span class="context-menu-shortcut">Ctrl+C</span>
            </div>
            <div class="context-menu-item" data-action="paste">
                <i class="fas fa-paste"></i>
                <span>Вставить</span>
                <span class="context-menu-shortcut">Ctrl+V</span>
            </div>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-section">
            <div class="context-menu-item" data-action="undo">
                <i class="fas fa-undo"></i>
                <span>Отменить</span>
                <span class="context-menu-shortcut">Ctrl+Z</span>
            </div>
            <div class="context-menu-item" data-action="redo">
                <i class="fas fa-redo"></i>
                <span>Повторить</span>
                <span class="context-menu-shortcut">Ctrl+Y</span>
            </div>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-section">
            <div class="context-menu-item" data-action="find">
                <i class="fas fa-search"></i>
                <span>Найти</span>
                <span class="context-menu-shortcut">Ctrl+F</span>
            </div>
            <div class="context-menu-item" data-action="replace">
                <i class="fas fa-exchange-alt"></i>
                <span>Заменить</span>
                <span class="context-menu-shortcut">Ctrl+R</span>
            </div>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-section">
            <div class="context-menu-item" data-action="addService">
                <i class="fas fa-plus-circle"></i>
                <span>Добавить сервис</span>
            </div>
            <div class="context-menu-item" data-action="addCharacteristic">
                <i class="fas fa-list"></i>
                <span>Добавить характеристику</span>
            </div>
            <div class="context-menu-item" data-action="addOption">
                <i class="fas fa-cog"></i>
                <span>Добавить опцию</span>
            </div>
            <div class="context-menu-item" data-action="addLink">
                <i class="fas fa-link"></i>
                <span>Добавить линк</span>
            </div>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-section">
            <div class="context-menu-item" data-action="fixRequirements">
                <i class="fas fa-wrench"></i>
                <span>Исправить под требования</span>
            </div>
            <div class="context-menu-item" data-action="validate">
                <i class="fas fa-check-circle"></i>
                <span>Валидировать</span>
            </div>
            <div class="context-menu-item" data-action="format">
                <i class="fas fa-indent"></i>
                <span>Форматировать</span>
            </div>
        </div>
    </div>

    <!-- Универсальный модальный компонент выбора из списка -->
    <div id="modalSelectDialog" class="modal-select-dialog" style="display:none;">
        <div class="modal-select-content">
            <div class="modal-select-header">
                <button id="modalSelectBackBtn" class="modal-select-back" style="display:none;">
                    <svg width="40" height="40" viewBox="0 0 40 40">
                        <polyline points="26,10 14,20 26,30" stroke="currentColor" stroke-width="3.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="14" y1="20" x2="32" y2="20" stroke="currentColor" stroke-width="3.5" stroke-linecap="round"/>
                    </svg>
                </button>
                <span id="modalSelectTitle"></span>
                <button id="modalSelectCloseBtn" class="modal-select-close">×</button>
            </div>
            <div class="modal-select-search-container">
                <input id="modalSelectSearch" type="text" placeholder="Поиск..." autocomplete="off" />
            </div>
            <div id="modalSelectList" class="modal-select-list"></div>
            <div id="modalSelectFooter" class="modal-select-footer"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="scripts/utils.js"></script>
    <script src="scripts/corrections.js"></script>
    <script src="scripts/editor.js"></script>
    <script src="scripts/editor-toolbar.js"></script>
    <script src="scripts/validation.js"></script>
    <script src="scripts/archive.js"></script>
    <script src="scripts/context-menu.js"></script>
</body>
</html>