# Циркадное освещение
# Глобальный и логический сценарии

Глобальный и логический сценарий для реализации полноценного циркадного освещения для ламп в Sprut.Hub.

## Логический сценарий

Режим активируется для каждой конкретной лампы и всегда работает когда она включена, обновляя значения яркости и цветовой температуры, если лампа поддерживает или оттенка с насыщенностью раз в 5 минут.

### Параметры:
#### Не менять параметр автоматически после его ручного изменения.
Если включено, то при ручном (или внешнем) изменении любого параметра (яркость, температура, оттенок, насыщенность) это сохранение запомнится и не будет устанавливаться циркадное значение. Сбрасывается при выключении лампы.

#### Останавливать циркадный режим после изменения любого параметра.
Если включено, то при изменении любого параметра лампочки циркадный режим отключается до следующего включения лампы. Если включить лампу изменением яркости, то циркадный режим запущен не будет, только установится температура. Для работы этого параметра необходимо включить пункт "Не менять яркость автоматически после ручного изменения."

#### Режим работы - Несколько пресетов с разными параметрами яркости и температуры. 
-  0 - Долго держится большая яркость, температура света утром холоднеет медленее
-  1 - Яркость вечером уменьшается раньше, утром включается холодный свет
-  2 - С постоянной максимальной яркостью. утром включается холодный свет
  
Настройки режимов можно изменить в глобальном сценарии. А так же можно добавить свои режимы.

## Глобальный сценарий

Используется для получения и установки циркадного освещения для ламп. Логический не работает без глобального!
Примеры:
Установить для одной лампочки: global.setCircadianLight(99);
Установить для нескольких лампочек global.setCircadianLight([97,98,99]);
Так же в метод setCircadianLight можно передать 2 параметра:
preset (Integer) - режим работы
dontChangeBright (Boolean) - не менять яркость при её ручном изменении

Получить значение температуры и яркости для текущего часа и минуты:
let tempAndBright = global.getCircadianLight(preset);
preset (Integer) - режим работы
Результат будет в виде массива
tempAndBright[0] - температура
tempAndBright[1] - яркость.
Используется, если необходимо получить только одно значение, например при использовании лампочки в качестве будильника получать температуру, а яркость увеличивать постепенно.

## Конвертер температуры в цвет
Дополнительный логиеский сценарий для конвертирования температуры в цвет у виртуальных устройств. 
Используется в связях (Одна лампа управляет группой ламп): Создаётся виртуальная лампа только с яркостью и температурой. Она связывается с лампами, которые тоже умеют управлять температурой, а так же с виртуальной лампой, где включена эта логика конвертера. А её уже с реальными лампами, которые умеют менять оттенок и насыщенность, но не умеют менять температуру. Это необходимо из-за того, что если есть температура, то управление идёт по температуре, если температуры нет, но есть оттенок и насыщенность, то ими. Потому что это взаимозаменяющие вещи, и, если управлять тем и тем, то результат будет не предсказуем. 

# История изменений:
## 2.2
- Параметры (режимы, температура в яркость и насыщенность) вынесены в отдельный сценарий, что бы можно было проще обновлять основной с логикой, а параметры не трогать.
- Добавлена толлератность для изменения характееристик - больше 1. Иногда приходило от девайса значение отличающее на 1 от того, что мы хотели и от этого не менялась температура.
- Доработано логирование

## 2.1
- Добавлен дополнительный логический сценарий "Конвертер температуры в цвет"
- Почистил сценарий от лшнего лога и ненужного кода

## 2.0 
- Эмуляция цветовой температуры посредством изменения оттенка и насыщенности, если у лампы нет этого параметра
- Опция "Останавливать циркадный режим после изменения любого параметра."
- Опция "Не менять яркость автоматически после ручного изменения" заменена на "Не менять параметр автоматически"
- Доработано логирование
- Добавлена глобальная функция global.getHueAndSaturationFromMired(temp) - которая возвращает массив [оттенок, насыщенность] для указанной температуры в майредах (как в хабе 50-400)
- Немного изменён формат задания режимов для удобства


## 1.0 Первый релиз